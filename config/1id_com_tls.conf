# 1id.com -- Full TLS config with content negotiation, Keycloak proxy, API proxy
# Serves: 1id.com and www.1id.com
# Cert: /etc/letsencrypt/live/1id.com/
#
# Content negotiation at root (/):
#   Accept: application/json -> /.well-known/1id.json  (via map in 00-1id-maps.conf)
#   Accept: text/markdown    -> /enroll.md
#   default                  -> /index.html

server {
    listen 443 ssl;
    listen [::]:443 ssl;

    listen 443 quic;
    listen [::]:443 quic;

    http2 on;
    http3 on;

    server_name 1id.com www.1id.com;

    ssl_certificate     /etc/letsencrypt/live/1id.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/1id.com/privkey.pem;

    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    root /srv/www/1id.com/html;

    # --- Content negotiation at root ---
    # Uses the $oneid_root_content_negotiation_target variable from 00-1id-maps.conf
    # which maps Accept header to the appropriate file path
    location = / {
        rewrite ^ $oneid_root_content_negotiation_target last;
    }

    # --- Machine-readable metadata: JSON ---
    location = /.well-known/1id.json {
        default_type application/json;
        add_header Access-Control-Allow-Origin "*" always;
        add_header Cache-Control "public, max-age=3600" always;
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    }

    # --- Machine-readable metadata: plain text for LLMs ---
    location = /llms.txt {
        default_type "text/plain; charset=utf-8";
        add_header Cache-Control "public, max-age=3600" always;
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    }

    # --- Machine-readable metadata: enrollment instructions ---
    location = /enroll.md {
        default_type "text/markdown; charset=utf-8";
        add_header Cache-Control "public, max-age=3600" always;
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    }

    # --- Keycloak OIDC endpoints (proxied to local Keycloak on port 8088) ---
    # Will serve the 'agents' realm once it is created
    location /realms/ {
        proxy_pass http://127.0.0.1:8088;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Port 443;
        proxy_buffering off;
    }

    # --- Keycloak resources (JS, CSS for login pages) ---
    location /resources/ {
        proxy_pass http://127.0.0.1:8088;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto https;
    }

    # --- 1id Enrollment API (Python/FastAPI on port 8180) ---
    # Will return 502 until the backend is deployed -- this is expected
    location /api/ {
        proxy_pass http://127.0.0.1:8180;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # --- Static frontend (HTML, CSS, JS, docs) ---
    location / {
        try_files $uri $uri/ =404;
        index index.html;
    }
}
